<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Updated TSM Scorecard Generator</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2023.05.1/pyscript.css" />
    <script defer src="https://pyscript.net/releases/2023.05.1/pyscript.js"></script>

    <style>
        /* Modern Reset & Typography */
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; padding: 20px; background-color: #f4f6f8; color: #333; }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 10px; }
        p.subtitle { text-align: center; color: #7f8c8d; margin-bottom: 30px; }

        /* Card Container */
        .container { 
            background: white; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
            text-align: center;
        }

        /* File Input Styling */
        input[type="file"] {
            border: 2px dashed #cbd5e0;
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
            border-radius: 8px;
            background-color: #fafbfc;
            cursor: pointer;
        }
        input[type="file"]:hover { border-color: #4299e1; background-color: #ebf8ff; }

        /* Button Styling */
        .btn { 
            background-color: #cbd5e0; 
            color: #fff; 
            padding: 14px 28px; 
            border: none; 
            border-radius: 6px; 
            font-size: 16px; 
            font-weight: 600; 
            margin-top: 20px; 
            cursor: not-allowed; 
            width: 100%;
            transition: all 0.3s ease;
        }
        .btn.ready { 
            background-color: #2b6cb0; 
            cursor: pointer; 
            box-shadow: 0 4px 6px rgba(43, 108, 176, 0.2); 
        }
        .btn.ready:hover { background-color: #2c5282; transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }

        /* Status Log Area */
        #status-area { 
            margin-top: 20px; 
            font-family: 'Consolas', 'Monaco', monospace; 
            font-size: 13px; 
            color: #4a5568; 
            background: #edf2f7; 
            padding: 15px; 
            border-radius: 6px; 
            text-align: left; 
            max-height: 150px; 
            overflow-y: auto; 
            display: none; /* Hidden by default */
            border-left: 4px solid #4299e1;
        }

        /* Table Styling */
        .table-responsive {
            overflow-x: auto;
            margin-top: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            min-width: 1000px; /* Forces scroll on small screens */
        }
        
        thead th { 
            background-color: #2d3748; 
            color: white; 
            padding: 15px; 
            text-align: center; 
            font-weight: 600;
            white-space: nowrap;
            position: sticky;
            top: 0;
        }
        
        tbody td { 
            padding: 12px 15px; 
            border-bottom: 1px solid #e2e8f0; 
            text-align: center;
            vertical-align: middle;
            font-size: 14px;
        }
        
        tbody tr:last-child td { border-bottom: none; }
        tbody tr:hover { background-color: #f7fafc; }
        
        /* First column (Names) sticky and bold */
        tbody td:first-child {
            text-align: left;
            font-weight: bold;
            color: #2d3748;
            background-color: white;
            position: sticky;
            left: 0;
            border-right: 2px solid #e2e8f0;
        }
        
        /* Circle Alignment */
        .score-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
    </style>
</head>
<body>

    <h1>üìä TSM Compliance Scorecard</h1>
    <p class="subtitle">Secure Browser Mode ‚Ä¢ Data Processed Locally</p>

    <div class="container">
        <p style="margin-bottom: 10px; font-weight: 500;">Select your 5 Salesforce Reports (CSV or Excel)</p>
        <input type="file" id="file_upload" multiple accept=".csv, .xlsx">
        <button id="run_btn" class="btn" disabled>‚è≥ Initializing Python...</button>
    </div>

    <div id="status-area"></div>
    
    <div id="output" class="table-responsive"></div>

    <py-config>
        packages = ["pandas", "openpyxl"]
    </py-config>

    <py-script>
import pandas as pd
import asyncio
import io
import datetime
from js import document, console, Uint8Array
from pyodide.ffi import create_proxy

# --- CONFIGURATION ---
TSM_NAMES = [
    "Adi Pandit", "Andrew Newhouse", "Eric Capponi", "Jeff Allen", 
    "Lar Collicott", "Matt Swanson", "Michael Bielak", "Peter Nguyen", "Preston Millett"
]
CURRENT_DATE = pd.to_datetime("today")
Q4_START_DATE = pd.to_datetime("2026-01-01")

# --- UI LOGGING ---
def log(message, clear=False):
    status_div = document.getElementById("status-area")
    if clear:
        status_div.innerHTML = ""
        status_div.style.display = "none"
        return
    
    status_div.style.display = "block"
    status_div.innerHTML += f"<div>{message}</div>"
    status_div.scrollTop = status_div.scrollHeight
    console.log(message)

# --- LOGIC ---
def get_compliance_circle(val):
    if val == 0: return "üü¢"
    if 1 <= val <= 2: return "üü°"
    return "üî¥"

def get_performance_circle(val):
    if val >= 3: return "üü¢"
    if 1 <= val <= 2: return "üü°"
    return "üî¥"

def clean_columns(df):
    df.columns = [str(c).split("‚Üë")[0].strip().replace(":", "").replace("  ", " ") for c in df.columns]
    return df

async def process_click(event):
    try:
        log("", clear=True)
        log("üöÄ Processing started...")
        
        file_input = document.getElementById("file_upload")
        files = file_input.files
        
        if files.length == 0:
            log("‚ö†Ô∏è Please upload files first.")
            return

        files_content = {}
        log(f"üìÇ Reading {files.length} files...")

        for i in range(files.length):
            file = files.item(i)
            array_buffer = await file.arrayBuffer()
            bytes_data = list(Uint8Array.new(array_buffer))
            files_content[file.name] = bytes(bytes_data)

        # Process Dataframes
        dfs = {
            "cos_no_wi": pd.DataFrame(), "cos": pd.DataFrame(),
            "wis": pd.DataFrame(), "wis_created": pd.DataFrame(),
            "movs": pd.DataFrame()
        }

        for filename, content in files_content.items():
            fname = filename.lower()
            try:
                f_io = io.BytesIO(content)
                if filename.endswith(".csv"):
                    # Header search
                    temp_df = pd.read_csv(f_io, header=None, nrows=25)
                    header_row = 0
                    for idx, row in temp_df.iterrows():
                        r_str = str(row.values).lower()
                        if "consumption change owner" in r_str or "primary assignee" in r_str or "moment of value" in r_str:
                            header_row = idx
                            break
                    f_io.seek(0)
                    df = pd.read_csv(f_io, header=header_row)
                else:
                    df = pd.read_excel(f_io)
                
                df = clean_columns(df)
                
                if "no wi" in fname: dfs["cos_no_wi"] = df
                elif "perspective - cos" in fname: dfs["cos"] = df
                elif "wis created" in fname: dfs["wis_created"] = df
                elif "perspective - tsm wis" in fname: dfs["wis"] = df
                elif "movs" in fname: dfs["movs"] = df
                
            except Exception as e:
                log(f"‚ùå Error in {filename}: {e}")

        # --- CALCULATIONS ---
        log("üßÆ Calculating Metrics...")
        results = pd.DataFrame(index=TSM_NAMES)
        
        def filter_tsm(df, col):
            if col not in df.columns: return pd.DataFrame()
            df[col] = df[col].fillna(method='ffill')
            df = df[~df[col].astype(str).str.contains("Subtotal|Total", case=False, na=False)]
            for c in df.columns:
                if "Date" in c: df[c] = pd.to_datetime(df[c], errors='coerce')
            if "Amount" in df.columns: df["Amount"] = pd.to_numeric(df["Amount"], errors='coerce').fillna(0)
            
            lower_names = [n.lower() for n in TSM_NAMES]
            return df[df[col].astype(str).str.lower().isin(lower_names)]

        # 1. COs
        if not dfs["cos"].empty:
            df = filter_tsm(dfs["cos"], "Consumption Change Owner")
            col = "Consumption Change Owner"
            if not df.empty:
                cutoff = CURRENT_DATE - pd.Timedelta(days=14)
                
                # Missing Notes
                if "Next Steps" in df.columns:
                    missing = df[df["Next Steps"].isna() | (df["Next Steps"].astype(str).str.strip().isin(["-", ""]))]
                    results["COs_Missing_Notes"] = results.index.map(missing.groupby(missing[col].str.title()).size()).fillna(0)
                
                # Stale
                stale = df[df["Last Modified Date"] < cutoff]
                results["COs_Stale"] = results.index.map(stale.groupby(stale[col].str.title()).size()).fillna(0)
                
                # Launch/Exec
                past_launch = df[(df["Stage"] != "Execution") & (df["Launch Date"] < CURRENT_DATE)]
                results["COs_Past_Launch"] = results.index.map(past_launch.groupby(past_launch[col].str.title()).size()).fillna(0)
                
                expired = df[(df["Stage"] == "Execution") & (df["Close Date"] < CURRENT_DATE)]
                results["COs_Expired"] = results.index.map(expired.groupby(expired[col].str.title()).size()).fillna(0)
                
                # Created
                created = df[df["Created Date"] >= Q4_START_DATE]
                results["COs_Created"] = results.index.map(created.groupby(created[col].str.title()).size()).fillna(0)
                results["COs_Amount"] = results.index.map(created.groupby(created[col].str.title())["Amount"].sum()).fillna(0)

        # 2. No WI
        if not dfs["cos_no_wi"].empty:
            df = filter_tsm(dfs["cos_no_wi"], "Consumption Change Owner")
            if not df.empty:
                results["COs_No_WI"] = results.index.map(df.groupby(df["Consumption Change Owner"].str.title()).size()).fillna(0)

        # 3. WIs
        if not dfs["wis"].empty:
            df = filter_tsm(dfs["wis"], "Primary Assignee Full Name")
            col = "Primary Assignee Full Name"
            if not df.empty and "Status" in df.columns:
                active = df[~df["Status"].isin(["Completed", "Canceled", "Rejected"])]
                overdue = active[active["End Date"] < CURRENT_DATE]
                results["WIs_Overdue"] = results.index.map(overdue.groupby(overdue[col].str.title()).size()).fillna(0)
                
                cutoff = CURRENT_DATE - pd.Timedelta(days=14)
                stale = active[active["Last Modified Date"] < cutoff]
                results["WIs_Stale"] = results.index.map(stale.groupby(stale[col].str.title()).size()).fillna(0)

        # 4. WIs Created
        if not dfs["wis_created"].empty:
            df = filter_tsm(dfs["wis_created"], "Primary Assignee Full Name")
            col = "Primary Assignee Full Name"
            if not df.empty:
                created = df[df["Created Date"] >= Q4_START_DATE]
                results["WIs_Created"] = results.index.map(created.groupby(created[col].str.title()).size()).fillna(0)

        # 5. MOVs
        if not dfs["movs"].empty:
            df = filter_tsm(dfs["movs"], "Moment of Value Created By")
            col = "Moment of Value Created By"
            if not df.empty:
                created = df[df["Moment of Value Created Date"] >= Q4_START_DATE]
                results["MOVs_Created"] = results.index.map(created.groupby(created[col].str.title()).size()).fillna(0)

        # --- GENERATE HTML ---
        results = results.fillna(0)
        
        html = "<table><thead><tr><th>TSM Name</th>"
        headers = ["No WI", "Missing Notes", "Stale Updates", "Past Launch", "Expired Exec", "WIs Overdue", "WIs Stale", "COs Created", "COs $$$", "WIs Created", "MOVs Created"]
        map_cols = ["COs_No_WI", "COs_Missing_Notes", "COs_Stale", "COs_Past_Launch", "COs_Expired", "WIs_Overdue", "WIs_Stale", "COs_Created", "COs_Amount", "WIs_Created", "MOVs_Created"]
        
        for h in headers: html += f"<th>{h}</th>"
        html += "</tr></thead><tbody>"
        
        for tsm in TSM_NAMES:
            if tsm in results.index:
                row = results.loc[tsm]
                html += f"<tr><td>{tsm}</td>"
                
                # Compliance
                for i in range(7):
                    c = map_cols[i]
                    val = int(row.get(c, 0))
                    circle = get_compliance_circle(val)
                    html += f"<td><div class='score-cell'><span>{circle}</span><span>{val}</span></div></td>"
                
                # Performance
                val = int(row.get("COs_Created", 0))
                html += f"<td><div class='score-cell'><span>{get_performance_circle(val)}</span><span>{val}</span></div></td>"
                
                val = row.get("COs_Amount", 0)
                html += f"<td>${val:,.0f}</td>"
                
                val = int(row.get("WIs_Created", 0))
                html += f"<td><div class='score-cell'><span>{get_performance_circle(val)}</span><span>{val}</span></div></td>"
                
                val = int(row.get("MOVs_Created", 0))
                html += f"<td><div class='score-cell'><span>{get_performance_circle(val)}</span><span>{val}</span></div></td>"
                
                html += "</tr>"
        
        html += "</tbody></table>"
        document.getElementById("output").innerHTML = html
        log("‚úÖ Done! Table generated below.")

    except Exception as e:
        log(f"üî• Error: {str(e)}")
        console.error(e)

def main():
    btn = document.getElementById("run_btn")
    btn.addEventListener("click", create_proxy(process_click))
    btn.disabled = False
    btn.innerText = "Generate Scorecard"
    btn.classList.add("ready")

main()
    </py-script>
</body>
</html>
